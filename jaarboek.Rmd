---
title: "Omgaan met ontbrekende waarden in meetreeksen"
author: "Thierry Onkelinx, Koen Devos, Paul Quataert"
output: html_document
bibliography: JORN_2017.bib
---

```{r include = FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE
)
library(dplyr)
library(tidyr)
library(ggplot2)
library(INBOtheme)
library(plotly)
```

```{r}
n_data <- 50
n_set <- 50
intercept <- 10
trend <- 0.5
ruis <- 0.2
ontbrekend <- 0.5
set.seed(123)
```


Ontbrekende waarden zijn onvermijdelijk in langlopende meetreeksen. Deze gewoon negeren levert vaak een vertekend beeld op. Een goed voorbeeld hiervan is het totaal aantal dieren in een gebied. Indien we ontbrekende tellingen negeren dan zullen we een onderschatting krijgen van het totaal.

We lossen het probleem op door de ontbrekende gegevens in te vullen door ge誰mputeerde waarden. In ecologisch kringen wordt vaak gebruik gemaakt van enkelvoudige imputatie waarbij we de voorspelde waarde volgens een model gebruiken als ge誰mputeerde waarde [@UnderhillEtal1994;@TRIM;@birdSTAT].  Meervoudige imputatie is een gekend statistische techniek uit medische kringen [@Rubin1987]. Het belangrijkste verschil is dat ontbrekende waarden vervangen uit een willekeurige waarde die we trekken uit de verdeling van volgens het model waarschijnlijke waarden. Op die manier houden we rekening met de modelonzekerheid. Uiteraard hangt het resultaat hierdoor deels af van toeval. De figuur toont `r n_set` verschillende imputaties. Daarom herhalen we de gewenste berekeningen voor meerdere imputatiesets en middelen de resultaten uit.

@Onkelinx2016 vergeleken enkelvoudige en meervoudige imputatie. De belangrijkste conclussie is dat enkelvoudige imputatie de onzekerheid op het eindresultaat onderschat. De ge誰mputeerde waarden bevat immers geen onzekerheid waardoor de variabiliteit in de volledige gegevens afneemt. Bij meervoudige imputatie zien we net het omgekeerde: de onzekerheid op het eindresultaat is groter. Hier zijn de ge誰mputeerde waarden immers een bijkomende bron van onzekerheid waardoor de variabiliteit in de volledige gegevens toeneemt.

## Aanbevelingen

1. Probeer ontbrekende waarnemingen zoveel mogelijk te vermijden.
1. Gebruik steeds meervoudige imputatie.
1. Imputeer op basis van een voldoende complex model.

Om het gebruik van meervoudige imputatie in ecologie te vereenvoudigen, hebben we het R package `multimput` ontwikkeld [@multimput]. Dit is vrij beschikbaar via https://github.com/inbo/multimput

```{r}
dataset <- expand.grid(
  X = runif(n_data)
) %>%
  mutate(
    Y = intercept + trend * X + rnorm(n_data, mean = 0, sd = ruis),
    Meting = sample(
      c("Ontbrekend", "Waargenomen"), 
      size = n_data, 
      prob = c(ontbrekend, 1 - ontbrekend), 
      replace = TRUE
    )
  )
imputatie_model <- lm(Y ~ X, data = dataset, subset = Meting == "Waargenomen")
imputatie <- dataset %>%
  filter(Meting == "Ontbrekend")
voorspelling <- predict(imputatie_model, newdata = imputatie, se.fit = TRUE)
ruis_voorspelling <- summary(imputatie_model)$sigma
dataset <- imputatie %>%
  mutate(
    Meting = "Enkelvoudig",
    Y = voorspelling$fit
  ) %>%
  bind_rows(dataset) %>%
  merge(data.frame(Imputatieset = seq_len(n_set)))
dataset <- imputatie %>%
  merge(data.frame(Imputatieset = seq_len(n_set))) %>%
  mutate(
    Meting = "Meervoudig",
    Y = rnorm(
      nrow(imputatie) * n_set,
      mean = voorspelling$fit,
      sd = voorspelling$se.fit
    ) %>%
      rnorm(n = nrow(imputatie) * n_set, sd = ruis_voorspelling)
  ) %>%
  bind_rows(dataset) %>%
  mutate(Meting = 
      factor(
        Meting, 
        levels = c("Waargenomen", "Ontbrekend", "Meervoudig", "Enkelvoudig")
      )
  )
```

```{r}
resultaat <- function(df) {
  model <- lm(Y ~ X, data = df)
  lijn <- data.frame(X = seq(0, 1, length = 41))
  fit <- predict(model, newdata = lijn, se.fit = TRUE)
  lijn %>%
    mutate(Y = fit[["fit"]], SE = fit[["se.fit"]])
}
ruwe_trend <- dataset %>%
  filter(Meting %in% c("Waargenomen", "Meervoudig")) %>%
  group_by(Imputatieset) %>%
  do(
    Voorspelling = resultaat(.)
  ) %>%
  unnest(Voorspelling)
trend <- ruwe_trend %>%
  group_by(X) %>%
  arrange(Imputatieset) %>%
  mutate(
    Y_hat = cummean(Y),
    SE_hat = sqrt(cummean(SE ^ 2) + cummean((Y - Y_hat) ^ 2) * (Imputatieset + 1) / (Imputatieset - 1))
  ) %>%
  select(-Y, -SE, Y = Y_hat, SE = SE_hat) %>%
  mutate(Methode = "Meervoudig\nresultaat") %>%
  bind_rows(
    ruwe_trend %>%
      mutate(Methode = "Meervoudig\nruw")
  ) %>%
  mutate(
    Ondergrens = qnorm(0.025, Y, SE),
    Bovengrens = qnorm(0.975, Y, SE)
  ) %>%
  select(-SE) %>%
  gather("Type2", "Waarde", Y, Ondergrens, Bovengrens) %>%
  mutate(Type = ifelse(Type2 == "Y", "Schatting", "Grens"))
```


```{r fig.cap = "Gesimuleerde gegevens die het verschil tussen enkelvoudige en meervoudige imputatie illustreren."}
gg1 <- ggplot(dataset, aes(x = X, y = Y, colour = Meting, shape = Meting, frame = Imputatieset)) +
  geom_point() +
  scale_shape_manual(
    values = c(Waargenomen = 16, Ontbrekend = 1, Enkelvoudig = 15, Meervoudig = 17)
  )
gg2 <- ggplot(trend, aes(x = X, y = Waarde, frame = Imputatieset)) +
  geom_line(aes(colour = Methode, group = Type2, linetype = Type)) +
  scale_linetype_manual(values = c(2, 1))
subplot(ggplotly(gg2), ggplotly(gg1))
```

## Referenties
